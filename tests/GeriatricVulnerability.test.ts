import { TriageArbiter } from '../src/services/triageArbiter';
import { AssessmentProfile } from '../src/types/triage';

describe('Geriatric Vulnerability Detection (Unit & Integration)', () => {
  // --- HELPER ---
  const createProfile = (overrides: Partial<AssessmentProfile> = {}): AssessmentProfile => ({
    age: null,
    duration: '2 days',
    severity: 'mild',
    progression: 'stable',
    red_flags_resolved: true,
    red_flag_denials: 'None',
    summary: 'Test summary',
    triage_readiness_score: 1.0,
    symptom_category: 'simple',
    turn_count: 5,
    is_vulnerable: false, // Default to false
    ...overrides,
  });

  const mockHistory = [{ role: 'user' as const, text: 'I feel sick' }];

  // --- UNIT TESTS ---

  describe('Unit Tests: Classification Logic', () => {
    it('(U01) Users aged 65 are correctly classified as geriatric', () => {
      const profile = createProfile({ age: '65' });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(U02) Users aged > 65 are correctly classified as geriatric', () => {
      const profile = createProfile({ age: '80' });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(U03) Users aged 64 and below are NOT classified as geriatric', () => {
      const profile = createProfile({ age: '64' });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(false);
    });

    it('(U04) Null age values do not cause errors and return appropriate status', () => {
      const profile = createProfile({ age: null });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(false);
    });

    it('(U05) Undefined age values are handled safely', () => {
      const profile = createProfile({ age: undefined });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(false);
    });

    it('(U06) Age 0 is classified as vulnerable (Pediatric logic)', () => {
      const profile = createProfile({ age: '0' });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(U07) Extreme age (150) is classified as geriatric', () => {
      const profile = createProfile({ age: '150' });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(U08) Negative age (-5) is NOT classified as vulnerable (Parser strips sign)', () => {
      // Logic: normalizeAge("-5") -> 5.
      // 5 < 5 is false. 5 >= 65 is false.
      // Therefore, returns false (Standard).
      const profile = createProfile({ age: '-5' });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(false);
    });

    it('(U09) Returns true if ANY condition is met (Maternal OR Geriatric)', () => {
      // Age 30 (Not Geriatric) but Maternal Context
      const maternalHistory = [
        { role: 'user' as const, text: 'I am pregnant and have a headache' },
      ];
      const profile = createProfile({ age: '30' });

      TriageArbiter.evaluateAssessmentState(maternalHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(U10) Returns true if profile flag was already set', () => {
      // Age 30 (Not Geriatric), No Maternal context, but flag is TRUE
      const profile = createProfile({ age: '30', is_vulnerable: true });
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(U11) Returns false only when NO conditions are met', () => {
      const profile = createProfile({ age: '30' });
      // Clean history
      const history = [{ role: 'user' as const, text: 'I hurt my knee playing soccer' }];

      TriageArbiter.evaluateAssessmentState(history, profile, 1, 10, []);
      expect(profile.is_vulnerable).toBe(false);
    });
  });

  // --- INTEGRATION TESTS ---

  describe('Integration Tests: Flow & Behavior', () => {
    it('(I01) Complete flow: Input -> Classification -> Turn Floor Enforcement', () => {
      const profile = createProfile({ age: '72' });

      // Standard termination would be at Turn 4.
      // We test Turn 5.
      const result = TriageArbiter.evaluateAssessmentState(
        mockHistory,
        profile,
        5, // Current Turn
        5, // Total Planned (Would imply exhaustion/termination for normal user)
        [],
      );

      // 1. Classification
      expect(profile.is_vulnerable).toBe(true);

      // 2. Flow Modification (Turn Floor > 5)
      expect(result.signal).toBe('CONTINUE');
      expect(result.reason).toContain('Turn floor not reached for vulnerable category');
    });

    it('(I03) Dynamic Update: User updates age mid-conversation', () => {
      // 1. Initial State: Non-Geriatric
      const profile = createProfile({ age: '40' });
      let result = TriageArbiter.evaluateAssessmentState(mockHistory, profile, 2, 10, []);
      expect(profile.is_vulnerable).toBe(false);

      // 2. Update: User corrects age to 80
      profile.age = '80';
      result = TriageArbiter.evaluateAssessmentState(mockHistory, profile, 3, 10, []);

      // 3. Assertion: Status flips, stricter rules apply
      expect(profile.is_vulnerable).toBe(true);
    });

    it('(I04) Clinical Saturation Override: Geriatric user CAN exit early if stable', () => {
      // Setup: Geriatric user (75), Turn 5 (Below Floor 7)
      const profile = createProfile({ age: '75', is_vulnerable: true });
      const previousProfile = { ...profile }; // Identical to simulate stability

      // First stable turn
      TriageArbiter.evaluateAssessmentState(mockHistory, profile, 4, 10, [], previousProfile);

      // Second stable turn -> saturation should trigger
      const result = TriageArbiter.evaluateAssessmentState(
        mockHistory,
        profile,
        5,
        10,
        [],
        previousProfile,
      );

      // Expect TERMINATE despite being below floor 7
      expect(result.signal).toBe('TERMINATE');
      expect(result.reason).toContain('CLINICAL SATURATION');
    });
  });

  // --- REGRESSION TESTS ---

  describe('Regression Tests: Non-Geriatric Users', () => {
    it('(R01) Standard adult user exits at Turn 4 if readiness is high AND plan is exhausted', () => {
      const profile = createProfile({ age: '40' });

      const result = TriageArbiter.evaluateAssessmentState(
        mockHistory,
        profile,
        4, // Turn 4 (Standard Floor)
        4, // Total Planned 4 (Exhausted) -> This is critical for termination
        [],
      );

      expect(profile.is_vulnerable).toBe(false);
      // Assuming all other safety checks pass (red flags resolved, etc.)
      // and readiness is 1.0 (from createProfile helper)
      expect(result.signal).toBe('TERMINATE');
    });
  });
});
